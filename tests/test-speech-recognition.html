<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Recognition Manager 測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pulse-animation {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-6xl">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                🎙️ Speech Recognition Manager 測試
            </h1>
            <p class="text-gray-600">測試雙模式語音識別系統（Web Speech API / Whisper）</p>
        </div>

        <!-- 狀態面板 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- 系統狀態 -->
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">系統狀態</h3>
                <div id="systemStatus" class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-sm">管理器</span>
                        <span id="managerStatus" class="text-sm font-medium text-gray-400">未初始化</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">當前模式</span>
                        <span id="currentMode" class="text-sm font-medium text-gray-400">無</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">識別狀態</span>
                        <span id="recognitionStatus" class="text-sm font-medium text-gray-400">閒置</span>
                    </div>
                </div>
            </div>

            <!-- 可用引擎 -->
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">可用引擎</h3>
                <div id="availableEngines" class="space-y-1">
                    <div class="text-sm text-gray-400">檢測中...</div>
                </div>
            </div>

            <!-- 效能指標 -->
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">效能指標</h3>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-sm">延遲</span>
                        <span id="latency" class="text-sm font-medium text-gray-400">-- ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">處理時間</span>
                        <span id="processingTime" class="text-sm font-medium text-gray-400">-- ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm">信心度</span>
                        <span id="confidence" class="text-sm font-medium text-gray-400">--%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">控制面板</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 基本控制 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">模式選擇</label>
                        <div class="flex gap-2">
                            <button id="autoMode" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                自動
                            </button>
                            <button id="webSpeechMode" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                Web Speech
                            </button>
                            <button id="whisperMode" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                Whisper
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">語言設定</label>
                        <select id="languageSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="zh-TW">中文（臺灣）</option>
                            <option value="zh-CN">中文（中国）</option>
                            <option value="en-US">English (US)</option>
                            <option value="ja-JP">日本語</option>
                            <option value="ko-KR">한국어</option>
                        </select>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">即時識別</label>
                        <div class="flex gap-2">
                            <button id="startBtn" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
                                開始識別
                            </button>
                            <button id="stopBtn" class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition" disabled>
                                停止識別
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">檔案轉譯</label>
                        <input type="file" id="fileInput" accept="audio/*" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
        </div>

        <!-- 識別結果 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- 即時結果 -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-3">即時識別結果</h3>
                <div class="space-y-2">
                    <div>
                        <label class="text-sm text-gray-500">臨時結果：</label>
                        <div id="interimResult" class="mt-1 p-3 bg-gray-50 rounded min-h-[60px] text-gray-600 italic">
                            等待輸入...
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">最終結果：</label>
                        <div id="finalResult" class="mt-1 p-3 bg-blue-50 rounded min-h-[100px] text-gray-800">
                            等待識別...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 檔案轉譯結果 -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-3">檔案轉譯結果</h3>
                <div id="fileTranscription" class="p-3 bg-gray-50 rounded min-h-[180px] text-gray-700">
                    <div class="text-gray-400">請選擇音訊檔案進行轉譯...</div>
                </div>
                <div id="transcriptionProgress" class="mt-3 hidden">
                    <div class="flex justify-between text-sm mb-1">
                        <span>轉譯進度</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 事件日誌 -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">事件日誌</h3>
                <button id="clearLog" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                    清除日誌
                </button>
            </div>
            <div id="eventLog" class="h-48 overflow-y-auto bg-gray-900 text-green-400 p-3 rounded font-mono text-sm">
                <div class="text-gray-500">系統準備中...</div>
            </div>
        </div>

        <!-- 測試案例 -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-3">快速測試</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button class="test-case px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition" data-test="webSpeechBasic">
                    Web Speech 基本測試
                </button>
                <button class="test-case px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition" data-test="modeSwitch">
                    模式切換測試
                </button>
                <button class="test-case px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition" data-test="errorRecovery">
                    錯誤恢復測試
                </button>
                <button class="test-case px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition" data-test="whisperLoad">
                    Whisper 載入測試
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { getSpeechRecognitionManager } from './js/modules/speech-recognition-manager.js';

        // 全域變數
        let manager = null;
        let isRecognizing = false;
        let startTime = null;
        let isTranscribing = false;
        let transcriptionText = '';  // 累積的轉譯文本

        // DOM 元素
        const elements = {
            // 狀態元素
            managerStatus: document.getElementById('managerStatus'),
            currentMode: document.getElementById('currentMode'),
            recognitionStatus: document.getElementById('recognitionStatus'),
            availableEngines: document.getElementById('availableEngines'),
            latency: document.getElementById('latency'),
            processingTime: document.getElementById('processingTime'),
            confidence: document.getElementById('confidence'),
            
            // 控制元素
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            autoMode: document.getElementById('autoMode'),
            webSpeechMode: document.getElementById('webSpeechMode'),
            whisperMode: document.getElementById('whisperMode'),
            languageSelect: document.getElementById('languageSelect'),
            fileInput: document.getElementById('fileInput'),
            
            // 結果元素
            interimResult: document.getElementById('interimResult'),
            finalResult: document.getElementById('finalResult'),
            fileTranscription: document.getElementById('fileTranscription'),
            transcriptionProgress: document.getElementById('transcriptionProgress'),
            progressText: document.getElementById('progressText'),
            progressBar: document.getElementById('progressBar'),
            
            // 日誌
            eventLog: document.getElementById('eventLog'),
            clearLog: document.getElementById('clearLog')
        };

        // 日誌功能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'fade-in';
            
            const colors = {
                info: 'text-green-400',
                warn: 'text-yellow-400',
                error: 'text-red-400',
                success: 'text-blue-400'
            };
            
            logEntry.className += ' ' + (colors[type] || colors.info);
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            elements.eventLog.appendChild(logEntry);
            elements.eventLog.scrollTop = elements.eventLog.scrollHeight;
        }

        // 更新狀態顯示
        function updateStatus() {
            if (!manager) return;
            
            const status = manager.getStatus();
            
            elements.managerStatus.textContent = status.isInitialized ? '已初始化' : '未初始化';
            elements.managerStatus.className = `text-sm font-medium ${status.isInitialized ? 'text-green-600' : 'text-gray-400'}`;
            
            elements.currentMode.textContent = status.currentMode || '無';
            elements.currentMode.className = `text-sm font-medium ${status.currentMode ? 'text-blue-600' : 'text-gray-400'}`;
            
            elements.recognitionStatus.textContent = status.isActive ? '識別中' : '閒置';
            elements.recognitionStatus.className = `text-sm font-medium ${status.isActive ? 'text-green-600 pulse-animation' : 'text-gray-400'}`;
            
            // 更新可用引擎列表
            if (status.availableEngines.length > 0) {
                elements.availableEngines.innerHTML = status.availableEngines.map(engine => `
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm">${engine}</span>
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    </div>
                `).join('');
            }
        }

        // 初始化管理器
        async function initializeManager() {
            try {
                log('正在初始化 Speech Recognition Manager...');
                
                manager = getSpeechRecognitionManager({
                    defaultMode: 'auto',
                    language: 'zh-TW',
                    continuous: true,
                    interimResults: true
                });

                // 設定事件監聽器
                manager.on('start', () => {
                    log('語音識別已開始', 'success');
                    startTime = Date.now();
                    updateStatus();
                });

                manager.on('end', () => {
                    log('語音識別已結束');
                    updateStatus();
                });

                manager.on('speechStart', () => {
                    log('檢測到語音開始');
                });

                manager.on('speechEnd', () => {
                    log('檢測到語音結束');
                });

                manager.on('interimResult', (data) => {
                    elements.interimResult.textContent = data.transcript;
                    
                    if (startTime) {
                        const latency = Date.now() - startTime;
                        elements.latency.textContent = `${latency} ms`;
                        elements.latency.className = `text-sm font-medium ${latency < 100 ? 'text-green-600' : latency < 200 ? 'text-yellow-600' : 'text-red-600'}`;
                    }
                });

                manager.on('result', (data) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'fade-in mb-2 p-2 bg-white rounded';
                    resultDiv.innerHTML = `
                        <div class="font-medium">${data.transcript}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            引擎: ${data.engine} | 信心度: ${(data.confidence * 100).toFixed(1)}%
                        </div>
                    `;
                    
                    if (elements.finalResult.querySelector('.text-gray-400')) {
                        elements.finalResult.innerHTML = '';
                    }
                    elements.finalResult.appendChild(resultDiv);
                    
                    // 更新信心度
                    elements.confidence.textContent = `${(data.confidence * 100).toFixed(1)}%`;
                    elements.confidence.className = `text-sm font-medium ${data.confidence > 0.8 ? 'text-green-600' : data.confidence > 0.6 ? 'text-yellow-600' : 'text-red-600'}`;
                    
                    log(`識別結果: "${data.transcript}" (信心度: ${(data.confidence * 100).toFixed(1)}%)`, 'success');
                });

                manager.on('error', (error) => {
                    log(`錯誤: ${error.message || error}`, 'error');
                });

                manager.on('modeChanged', (data) => {
                    log(`模式已切換至: ${data.mode}`, 'info');
                    updateStatus();
                    updateModeButtons(data.mode);
                });

                manager.on('loadProgress', (data) => {
                    log(`模型載入中: ${data.progress}% - ${data.message}`, 'info');
                    if (elements.transcriptionProgress.classList.contains('hidden')) {
                        elements.transcriptionProgress.classList.remove('hidden');
                    }
                    elements.progressText.textContent = `${data.progress}%`;
                    elements.progressBar.style.width = `${data.progress}%`;
                });

                manager.on('modelLoaded', () => {
                    log('Whisper 模型載入完成', 'success');
                    setTimeout(() => {
                        elements.transcriptionProgress.classList.add('hidden');
                    }, 1000);
                });

                // 初始化
                await manager.initialize();
                
                log('Speech Recognition Manager 初始化完成', 'success');
                updateStatus();
                
            } catch (error) {
                log(`初始化失敗: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // 更新模式按鈕狀態
        function updateModeButtons(mode) {
            const buttons = {
                auto: elements.autoMode,
                webspeech: elements.webSpeechMode,
                whisper: elements.whisperMode
            };
            
            Object.keys(buttons).forEach(key => {
                if (key === mode || (mode === 'webspeech' && key === 'auto')) {
                    buttons[key].className = 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition';
                } else {
                    buttons[key].className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition';
                }
            });
        }

        // 開始識別
        async function startRecognition() {
            if (!manager || isRecognizing) return;
            
            try {
                const language = elements.languageSelect.value;
                await manager.start({ language });
                
                isRecognizing = true;
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
                
                elements.interimResult.textContent = '聆聽中...';
                elements.finalResult.innerHTML = '<div class="text-gray-400">等待語音輸入...</div>';
                
            } catch (error) {
                log(`啟動失敗: ${error.message}`, 'error');
            }
        }

        // 停止識別
        async function stopRecognition() {
            if (!manager || !isRecognizing) return;
            
            try {
                await manager.stop();
                
                isRecognizing = false;
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                
            } catch (error) {
                log(`停止失敗: ${error.message}`, 'error');
            }
        }

        // 切換模式
        async function switchMode(mode) {
            if (!manager) return;
            
            try {
                if (mode === 'auto') {
                    const detectedMode = await manager.determineMode();
                    await manager.setMode(detectedMode);
                } else {
                    await manager.switchMode(mode);
                }
            } catch (error) {
                log(`模式切換失敗: ${error.message}`, 'error');
            }
        }

        // 處理檔案上傳
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !manager) return;
            
            log(`開始轉譯檔案: ${file.name}`, 'info');
            elements.fileTranscription.innerHTML = '<div class="text-gray-500">載入模型中，請稍候...</div>';
            elements.transcriptionProgress.classList.remove('hidden');
            
            // 重置轉譯狀態
            isTranscribing = true;
            transcriptionText = '';
            
            // 設定串流更新的事件監聽器
            const handleStreamUpdate = (data) => {
                if (data.transcript) {
                    transcriptionText = data.transcript;
                    elements.fileTranscription.innerHTML = `
                        <div class="mb-2 text-sm text-gray-500">檔案: ${file.name}</div>
                        <div class="text-gray-800">
                            ${transcriptionText}
                            <span class="inline-block ml-1 w-2 h-4 bg-blue-500 animate-pulse"></span>
                        </div>
                    `;
                }
            };
            
            // 註冊臨時的串流更新監聽器
            manager.on('interimTranscription', handleStreamUpdate);
            
            try {
                const transcript = await manager.transcribeFile(file, {
                    language: elements.languageSelect.value
                });
                
                // 最終結果
                elements.fileTranscription.innerHTML = `
                    <div class="mb-2 text-sm text-gray-500">檔案: ${file.name}</div>
                    <div class="text-gray-800">${transcript}</div>
                `;
                
                log('檔案轉譯完成', 'success');
                
            } catch (error) {
                elements.fileTranscription.innerHTML = `
                    <div class="text-red-500">轉譯失敗: ${error.message}</div>
                `;
                log(`檔案轉譯失敗: ${error.message}`, 'error');
            } finally {
                // 清理
                isTranscribing = false;
                manager.off('interimTranscription', handleStreamUpdate);
                setTimeout(() => {
                    elements.transcriptionProgress.classList.add('hidden');
                }, 1000);
            }
        }

        // 執行測試案例
        async function runTestCase(testName) {
            log(`執行測試: ${testName}`, 'info');
            
            switch(testName) {
                case 'webSpeechBasic':
                    await switchMode('webspeech');
                    await startRecognition();
                    setTimeout(() => stopRecognition(), 5000);
                    break;
                    
                case 'modeSwitch':
                    await switchMode('webspeech');
                    setTimeout(async () => {
                        await switchMode('whisper');
                        setTimeout(() => switchMode('auto'), 2000);
                    }, 2000);
                    break;
                    
                case 'errorRecovery':
                    // 模擬錯誤情況
                    manager.emit('error', new Error('模擬錯誤'));
                    setTimeout(() => {
                        log('嘗試恢復...', 'warn');
                        initializeManager();
                    }, 2000);
                    break;
                    
                case 'whisperLoad':
                    await switchMode('whisper');
                    log('正在載入 Whisper 模型，這可能需要一些時間...', 'warn');
                    break;
            }
        }

        // 事件綁定
        elements.startBtn.addEventListener('click', startRecognition);
        elements.stopBtn.addEventListener('click', stopRecognition);
        elements.autoMode.addEventListener('click', () => switchMode('auto'));
        elements.webSpeechMode.addEventListener('click', () => switchMode('webspeech'));
        elements.whisperMode.addEventListener('click', () => switchMode('whisper'));
        elements.fileInput.addEventListener('change', handleFileUpload);
        elements.clearLog.addEventListener('click', () => {
            elements.eventLog.innerHTML = '<div class="text-gray-500">日誌已清除</div>';
        });

        // 測試案例按鈕
        document.querySelectorAll('.test-case').forEach(button => {
            button.addEventListener('click', (e) => {
                runTestCase(e.target.dataset.test);
            });
        });

        // 頁面載入時初始化
        window.addEventListener('load', () => {
            log('頁面載入完成，開始初始化系統...');
            initializeManager();
        });

        // 頁面卸載時清理
        window.addEventListener('beforeunload', async () => {
            if (manager) {
                await manager.dispose();
            }
        });
    </script>
</body>
</html>