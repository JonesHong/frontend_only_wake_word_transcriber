<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試遠端模型載入</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .progress {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 測試 Whisper 遠端模型載入</h1>
        
        <div class="test-section">
            <h2>1. 測試本地模型</h2>
            <button id="testLocal" onclick="testLocalModel()">載入本地模型</button>
            <div id="localStatus" class="status info">等待測試...</div>
        </div>
        
        <div class="test-section">
            <h2>2. 測試遠端模型</h2>
            <button id="testRemote" onclick="testRemoteModel()">載入遠端模型 (Xenova/whisper-tiny)</button>
            <div id="remoteStatus" class="status info">等待測試...</div>
        </div>
        
        <div class="test-section">
            <h2>3. 測試快取</h2>
            <button id="testCache" onclick="testCache()">檢查 IndexedDB 快取</button>
            <div id="cacheStatus" class="status info">等待測試...</div>
        </div>
    </div>

    <script type="module">
        let worker = null;
        
        window.testLocalModel = async function() {
            const button = document.getElementById('testLocal');
            const status = document.getElementById('localStatus');
            
            button.disabled = true;
            status.className = 'status progress';
            status.textContent = '正在載入本地模型...';
            
            try {
                // 創建 Worker
                worker = new Worker('/js/workers/whisper.worker.js', { type: 'module' });
                
                // 設置訊息處理
                worker.onmessage = (event) => {
                    const data = event.data;
                    console.log('Worker message:', data);
                    
                    if (data.type === 'modelLoadProgress') {
                        status.textContent = `載入進度: ${data.progress}%\n${data.message}`;
                    } else if (data.type === 'modelLoaded') {
                        status.className = 'status success';
                        status.textContent = `✅ 本地模型載入成功！\n模型: ${data.model}\n來源: ${data.source}`;
                        button.disabled = false;
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                };
                
                // 初始化 Worker
                await sendWorkerMessage({
                    type: 'initialize',
                    config: {
                        language: 'zh',
                        task: 'transcribe'
                    }
                });
                
                // 載入本地模型
                await sendWorkerMessage({
                    type: 'loadModel',
                    config: {
                        model: 'models/huggingface/Xenova/whisper-base',
                        whisperModelSource: 'local',
                        quantized: false
                    }
                });
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = `❌ 載入失敗: ${error.message}`;
                button.disabled = false;
            }
        };
        
        window.testRemoteModel = async function() {
            const button = document.getElementById('testRemote');
            const status = document.getElementById('remoteStatus');
            
            button.disabled = true;
            status.className = 'status progress';
            status.textContent = '正在從 Hugging Face 載入遠端模型...\n首次載入可能需要幾分鐘...';
            
            try {
                // 創建新 Worker
                if (worker) {
                    worker.terminate();
                }
                worker = new Worker('/js/workers/whisper.worker.js', { type: 'module' });
                
                // 設置訊息處理
                worker.onmessage = (event) => {
                    const data = event.data;
                    console.log('Worker message:', data);
                    
                    if (data.type === 'modelLoadProgress') {
                        status.textContent = `載入進度: ${data.progress}%\n${data.message}`;
                    } else if (data.type === 'modelLoaded') {
                        status.className = 'status success';
                        status.textContent = `✅ 遠端模型載入成功！\n模型: ${data.model}\n來源: ${data.source}\n快取: ${data.cached}`;
                        button.disabled = false;
                    } else if (data.error) {
                        throw new Error(data.error);
                    }
                };
                
                // 初始化 Worker
                await sendWorkerMessage({
                    type: 'initialize',
                    config: {
                        language: 'zh',
                        task: 'transcribe'
                    }
                });
                
                // 載入遠端模型（使用較小的 tiny 模型進行測試）
                await sendWorkerMessage({
                    type: 'loadModel',
                    config: {
                        model: 'Xenova/whisper-tiny',
                        whisperModelSource: 'remote',
                        quantized: true
                    }
                });
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = `❌ 載入失敗: ${error.message}`;
                button.disabled = false;
            }
        };
        
        window.testCache = async function() {
            const status = document.getElementById('cacheStatus');
            status.className = 'status progress';
            status.textContent = '正在檢查 IndexedDB 快取...';
            
            try {
                // 打開 IndexedDB
                const databases = await indexedDB.databases();
                const transformersDBs = databases.filter(db => 
                    db.name && db.name.includes('transformers') || 
                    db.name && db.name.includes('onnx')
                );
                
                if (transformersDBs.length > 0) {
                    let cacheInfo = '找到以下快取資料庫:\n';
                    for (const db of transformersDBs) {
                        cacheInfo += `- ${db.name} (版本: ${db.version})\n`;
                        
                        // 嘗試獲取更多資訊
                        try {
                            const openDB = await new Promise((resolve, reject) => {
                                const request = indexedDB.open(db.name);
                                request.onsuccess = () => resolve(request.result);
                                request.onerror = () => reject(request.error);
                            });
                            
                            const objectStoreNames = Array.from(openDB.objectStoreNames);
                            cacheInfo += `  儲存區: ${objectStoreNames.join(', ')}\n`;
                            openDB.close();
                        } catch (e) {
                            console.error('Error opening DB:', e);
                        }
                    }
                    
                    status.className = 'status success';
                    status.textContent = `✅ ${cacheInfo}`;
                } else {
                    status.className = 'status info';
                    status.textContent = 'ℹ️ 尚未找到快取資料庫。載入遠端模型後會自動建立。';
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `❌ 檢查失敗: ${error.message}`;
            }
        };
        
        // Helper function to send messages to worker
        function sendWorkerMessage(message) {
            return new Promise((resolve, reject) => {
                const messageId = Math.random().toString(36).substr(2, 9);
                
                const handler = (event) => {
                    if (event.data.messageId === messageId) {
                        worker.removeEventListener('message', handler);
                        if (event.data.error) {
                            reject(new Error(event.data.error));
                        } else {
                            resolve(event.data);
                        }
                    }
                };
                
                worker.addEventListener('message', handler);
                worker.postMessage({ ...message, messageId });
                
                // Timeout after 60 seconds
                setTimeout(() => {
                    worker.removeEventListener('message', handler);
                    reject(new Error('Worker timeout'));
                }, 60000);
            });
        }
    </script>
</body>
</html>