<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper ä¸²æµè¼¸å‡ºæ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl w-full">
        <h1 class="text-2xl font-bold mb-6 text-center">ğŸ™ï¸ Whisper ä¸²æµè½‰è­¯æ¸¬è©¦</h1>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                é¸æ“‡éŸ³è¨Šæª”æ¡ˆé€²è¡Œè½‰è­¯
            </label>
            <input type="file" id="fileInput" accept="audio/*" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">èªè¨€</label>
            <select id="languageSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="zh-TW">ä¸­æ–‡ï¼ˆè‡ºç£ï¼‰</option>
                <option value="en-US">English (US)</option>
                <option value="ja-JP">æ—¥æœ¬èª</option>
            </select>
        </div>
        
        <div id="progressSection" class="mb-6 hidden">
            <div class="flex justify-between text-sm mb-1">
                <span>è¼‰å…¥é€²åº¦</span>
                <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                è½‰è­¯çµæœï¼ˆä¸²æµè¼¸å‡ºï¼‰
            </label>
            <div id="transcriptionOutput" class="min-h-[200px] p-4 border border-gray-300 rounded-md bg-gray-50">
                <div class="text-gray-400">è«‹é¸æ“‡æª”æ¡ˆé–‹å§‹è½‰è­¯...</div>
            </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
            <h3 class="font-semibold text-blue-900 mb-2">æ¸¬è©¦èªªæ˜</h3>
            <ul class="text-sm text-blue-800 space-y-1">
                <li>â€¢ ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆå¾Œæœƒè‡ªå‹•é–‹å§‹è½‰è­¯</li>
                <li>â€¢ æ–‡å­—æœƒå³æ™‚ä¸²æµé¡¯ç¤ºï¼ˆä¸æ˜¯ç­‰å…¨éƒ¨å®Œæˆæ‰é¡¯ç¤ºï¼‰</li>
                <li>â€¢ è—è‰²æ¸¸æ¨™è¡¨ç¤ºæ­£åœ¨è½‰è­¯ä¸­</li>
                <li>â€¢ æ”¯æ´ MP3ã€WAVã€OGG ç­‰æ ¼å¼</li>
            </ul>
        </div>
    </div>
    
    <script type="module">
        import { WhisperEngine } from './js/modules/engines/whisper-engine.js';
        
        const fileInput = document.getElementById('fileInput');
        const languageSelect = document.getElementById('languageSelect');
        const transcriptionOutput = document.getElementById('transcriptionOutput');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        
        let engine = null;
        let currentTranscription = '';
        
        async function initializeEngine() {
            engine = new WhisperEngine();
            
            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            engine.on('loadProgress', (data) => {
                console.log('Model loading progress:', data);
                progressSection.classList.remove('hidden');
                progressText.textContent = `${data.progress}%`;
                progressBar.style.width = `${data.progress}%`;
            });
            
            engine.on('modelLoaded', () => {
                console.log('Model loaded successfully');
                setTimeout(() => {
                    progressSection.classList.add('hidden');
                }, 1000);
            });
            
            // ä¸²æµæ›´æ–°ç›£è½å™¨
            engine.on('interimTranscription', (data) => {
                console.log('Streaming update:', data);
                updateTranscriptionDisplay(data, true);
            });
            
            engine.on('result', (data) => {
                console.log('Final result:', data);
                updateTranscriptionDisplay(data, false);
            });
            
            engine.on('error', (error) => {
                console.error('Engine error:', error);
                transcriptionOutput.innerHTML = `<div class="text-red-500">éŒ¯èª¤: ${error.message}</div>`;
            });
            
            await engine.initialize({
                language: 'zh'
            });
            
            console.log('Engine initialized');
        }
        
        function updateTranscriptionDisplay(data, isStreaming) {
            const text = data.transcript || '';
            const chunks = data.chunks || [];
            
            if (chunks.length > 0) {
                // é¡¯ç¤ºåˆ†æ®µçµæœï¼ˆåƒåƒè€ƒå¯¦ç¾é‚£æ¨£ï¼‰
                let html = '<div class="space-y-2">';
                chunks.forEach(chunk => {
                    const timestamp = chunk.timestamp ? formatTimestamp(chunk.timestamp[0]) : '';
                    html += `
                        <div class="flex items-start gap-3 p-2 bg-gray-50 rounded">
                            <span class="text-sm text-gray-500 font-mono">${timestamp}</span>
                            <span class="text-gray-800">${chunk.text || ''}</span>
                        </div>
                    `;
                });
                
                if (isStreaming) {
                    html += '<span class="inline-block ml-2 w-2 h-4 bg-blue-500 animate-pulse"></span>';
                }
                html += '</div>';
                transcriptionOutput.innerHTML = html;
            } else if (text) {
                // æ²’æœ‰åˆ†æ®µæ™‚é¡¯ç¤ºå®Œæ•´æ–‡å­—
                transcriptionOutput.innerHTML = `
                    <div class="text-gray-800">
                        ${text}
                        ${isStreaming ? '<span class="inline-block ml-1 w-2 h-4 bg-blue-500 animate-pulse"></span>' : ''}
                    </div>
                `;
            } else {
                // ç„¡å…§å®¹
                transcriptionOutput.innerHTML = `
                    <div class="text-gray-400">${isStreaming ? 'è½‰è­¯ä¸­...' : 'ï¼ˆç„¡å…§å®¹ï¼‰'}</div>
                `;
            }
        }
        
        function formatTimestamp(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Processing file:', file.name);
            
            // é‡ç½®é¡¯ç¤º
            currentTranscription = '';
            transcriptionOutput.innerHTML = '<div class="text-gray-500">é–‹å§‹è½‰è­¯...</div>';
            
            try {
                const result = await engine.transcribeFile(file, {
                    language: languageSelect.value
                });
                
                console.log('Transcription complete:', result);
                
            } catch (error) {
                console.error('Transcription error:', error);
                transcriptionOutput.innerHTML = `<div class="text-red-500">è½‰è­¯å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        // åˆå§‹åŒ–
        initializeEngine().catch(console.error);
        
        // äº‹ä»¶ç¶å®š
        fileInput.addEventListener('change', handleFileUpload);
    </script>
</body>
</html>