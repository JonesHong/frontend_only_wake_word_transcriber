# JS 檔案結構重組建議

## 當前結構分析

### 現有問題
1. 核心模組（wakeword.js, vad.js, speech.js）與 UI 模組混在根目錄
2. 新增的 modules/ 目錄僅包含音訊相關模組
3. workers/ 和 performance/ 目錄為空
4. 缺乏清晰的分層架構

## 建議的新結構

```
js/
├── config.js                 # 保持在根目錄（全域配置）
├── main.js                    # 保持在根目錄（主入口）
│
├── core/                      # 核心業務邏輯
│   ├── fsm.js                # 有限狀態機
│   ├── wakeword.js           # 喚醒詞偵測
│   ├── vad.js                # 語音活動偵測
│   └── speech.js             # 語音識別
│
├── audio/                     # 音訊處理相關
│   ├── input-manager.js      # 音訊輸入管理
│   ├── pipeline-manager.js   # 音訊管道管理
│   ├── diagnostics.js        # 音訊診斷工具
│   └── format-converter.js   # 格式轉換工具
│
├── ui/                        # UI 相關模組
│   ├── i18n.js               # 國際化
│   ├── language.js           # 語言切換
│   ├── theme.js              # 主題管理
│   ├── visualization.js     # 視覺化
│   ├── settings.js           # 設定管理
│   └── logger.js             # 日誌顯示
│
├── workers/                   # Web Workers
│   ├── ml-inference.worker.js        # ML 推論 Worker（待實作）
│   ├── whisper.worker.js            # Whisper Worker（待實作）
│   └── audio-processor.worker.js    # 音訊處理 Worker（待實作）
│
├── worklets/                  # Audio Worklets
│   └── audio-format-processor.worklet.js  # 格式處理 Worklet
│
├── utils/                     # 工具函數
│   ├── buffer-utils.js       # 緩衝區工具（待實作）
│   ├── audio-utils.js        # 音訊工具（待實作）
│   └── model-utils.js        # 模型工具（待實作）
│
└── models/                    # 模型管理（新增）
    ├── model-loader.js       # 模型載入器（待實作）
    ├── onnx-manager.js       # ONNX 管理器（待實作）
    └── whisper-manager.js    # Whisper 管理器（待實作）
```

## 重組步驟

### 第一階段：基礎重組（現在執行）
1. 創建新目錄結構
2. 移動現有檔案到對應目錄
3. 更新 import/script 路徑

### 第二階段：模組化改進（Worker 架構時）
1. 將全域變數改為 ES6 模組
2. 實作模組載入器
3. 優化依賴關係

### 第三階段：完整重構（後續優化）
1. 統一匯出介面
2. 實作延遲載入
3. 建立模組註冊機制

## 路徑更新影響

### index.html 需要更新的 script 標籤
```html
<!-- 配置 -->
<script src="js/config.js"></script>

<!-- UI 模組 -->
<script src="js/ui/i18n.js"></script>
<script src="js/ui/theme.js"></script>
<script src="js/ui/logger.js"></script>
<script src="js/ui/settings.js"></script>
<script src="js/ui/language.js"></script>
<script src="js/ui/visualization.js"></script>

<!-- 音訊模組 -->
<script src="js/audio/input-manager.js"></script>
<script src="js/audio/diagnostics.js"></script>
<script src="js/audio/pipeline-manager.js"></script>

<!-- 核心模組 -->
<script src="js/core/fsm.js"></script>
<script src="js/core/wakeword.js"></script>
<script src="js/core/vad.js"></script>
<script src="js/core/speech.js"></script>

<!-- 主程式 -->
<script src="js/main.js"></script>
```

## 優點

1. **清晰的分層**：core/audio/ui 明確區分功能領域
2. **易於維護**：相關功能集中管理
3. **擴展性好**：新功能有明確的歸屬
4. **符合最佳實踐**：遵循關注點分離原則
5. **為 Worker 架構準備**：workers/ 目錄已就位

## 建議執行順序

1. ✅ 先完成基礎重組（移動檔案）
2. ⏸️ Worker 架構實作時再進行模組化
3. ⏸️ 最後階段進行完整重構

這樣可以：
- 保持現有功能正常運作
- 逐步改進架構
- 降低重構風險